#!/usr/bin/env bash
#
# Functions
#
# @author Charlie Revett

# `asd` outputs all available functions from this file.
asd() {
  echo "> Available bash functions"
  echo "> See: ~/dotfiles/.functions"

  f=("branch" "find-free-port" "gh" "generate-passphrase" "gsync" "tldr" "tre")
  printf -- '  - %s\n' "${f[@]}"
}

# `branch` is used within a number of aliases, and returns the branch from the
# current git directory. Taken from oh-my-zsh.
# See: https://gist.github.com/DavidToca/3086571
branch() {
  ref=$(git symbolic-ref HEAD 2> /dev/null) || return
  echo ${ref#refs/heads/}
}

# `find-free-port` finds a local port that is not in use
find-free-port() {
  while true; do
    random_port=$(( ((RANDOM<<15)|RANDOM) % 49152 + 10000 ))
    status="$(nc -z 127.0.0.1 $random_port < /dev/null &>/dev/null; echo $?)"

    if [ "${status}" != "0" ]; then
      echo $random_port
      return 0
    fi
  done
}

# TODO: Fix so that `.git` is not URL suffix.
# `gh` opens the current repo in a browser.
gh() {
  open $(git config remote.origin.url | sed "s/git@\(.*\):\(.*\).git/https:\/\/\1\/\2/")
}

# `generate-passphrase` generates a random passphrase based password.
generate-passphrase() {
  CHUNKS=4
  if [ "$#" -eq 1 ]; then
    CHUNKS=$1
  fi

  gshuf -n$CHUNKS /usr/share/dict/words | tr -s '\n' '-' | sed 's/.$//' | awk '{print tolower($0)}'
}

# `gsync` is a helper function for moving back to the main branch of a repo and
# updating it with remote.
gsync() {
  BRANCH="master"

  if [ `git branch --list main` ]; then
    BRANCH="main"
  fi

  git ch $BRANCH
  git fetch
  git pull origin $BRANCH
}

# `tldr` wraps chubin/cheat.sh, and will pipe the resulting sheet in to less if
# it is longer than the height of the terminal.
# See: https://github.com/chubin/cheat.sh#usage
tldr() {
  CMD="curl --silent https://cheat.sh/$1"
  QUERY="$(shift 1; IFS="+"; echo "$*")"
  CMD="$CMD/$QUERY"

  echo "$CMD"

  SHEET=$($CMD)
  TERMINAL_LINES=$(tput lines)
  SHEET_LINES=$(echo "$SHEET" | wc -l)

  if [ "$SHEET_LINES" -gt "$TERMINAL_LINES" ]; then
    echo "$SHEET" | less -R
    return 0
  fi

  echo "$SHEET"
}

# `tre` is a shorthand for `tree` with hidden files and color enabled, ignoring
# the `.git` directory, listing directories first. The output gets piped into
# `less` with options to preserve color and line numbers, unless the output is
# small enough for one screen.
tre() {
  tree -aC -I '.git|node_modules|.cache' --dirsfirst "$@" | less -FRNX;
}
